---
title: "Project 1 - DATS 6101"
author: "Randomly-Generated: Tran Hieu Le, Fahim Ishrak, Zhilin Wang, Totyana Hill "
date: "9/29/2019"
output:
   html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, message = FALSE, warning = FALSE)
options(scipen=9, digits = 3) 
```

```{r define_loadPkg}
loadPkg = function(x) { if (!require(x,character.only=T, quietly =F)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T, quietly=T)) stop("Package not found") } }
```

### Chapter 1: Introduction


### Chapter 2: Description of Data

#### 2.1 Source Data

The links for the dataset is: https://www.kaggle.com/danielgrijalvas/movies , which was separated from IMDB.
 
#### 2.2 Data Explanation

There are 6820 movies in the dataset from 1986-2016. 

Explanation for columns attributes:

* budget: the budget of a movie
* company: the movie company
* country: the country that produces the movie
* director: the director of the movie
* genre: the main genre of the movie
* gross: revenue of the movie
* name: name of the movie
* rating: a system determines the suitability of movies for different audiences (classified by ages)
* released: release date (YYYY-MM-DD)
* runtime: the duration of the movie
* score: IMDB user rating
* votes: the number of user votes
* star: the main actor/actress
* writer: the writer of the movie
* year: the year of release



For our project, we will remove all movies that are television or DvDs versions (which did not follow the Motion Picture Association of America (MPAA) film rating system) and focus on movies published at theatre/cinema since our goal is to research the theatrical exhibition.

Movie ratings explanation according to MPAA system:

* G – General Audiences: All ages admitted. Nothing that would offend parents for viewing by children.
* PG – Parental Guidance Suggested: Some material may not be suitable for children. Parents urged to give "parental guidance". May contain some material parents might not like for their young children.
* PG-13 – Parents Strongly Cautioned: Some material may be inappropriate for children under 13. Parents are urged to be cautious. Some material may be inappropriate for pre-teenagers.
* R – Restricted: Under 17 requires accompanying parent or adult guardian. Contains some adult material. Parents are urged to learn more about the film before taking their young children with them.
* NC-17 – Adults Only: No One 17 and Under Admitted. Clearly adult. Children are not admitted.
 

#### 2.3 Data Cleaning

Step 1: Load dataset from csv file and save it as movies dataframe.


```{r load_data, include = T}

loadPkg("ggplot2")
loadPkg("dplyr")

# read dataset
movies <- read.csv("movies.csv")
str(movies)

```

Step 2: Clean the dataframe. We will save new dataset as movies_new

* Change all movies with budget = 0 to NA.

```{r NAs}

# assign NA to movies with budget = 0 
movies$budget <- replace(movies$budget,movies$budget==0, NA)

```

* Remove movies that are TV or DVDs versions.

```{r ratings_rework}

# filter for movies with MPAA film rating system 
movies_new <- subset(movies, movies$rating%in%c("G","NC-17","PG-13","R","PG"))


# apply factor again to new dataset
movies_new$rating <- factor(movies_new$rating) 
movies_new$genre <- factor(movies_new$genre)
```

* Remove duplicated data. Fortunately, all the data are distinct.

```{r duplicates}
# remove duplicates if they exist
movies_new <- unique(movies_new)

```

* Remove columns that will not be used.

```{r rmcol}

movies_new <- subset(movies_new, select = - c(company,director,released,runtime,star,writer))

```

* Since we will work on profit and return on investment later, we will create 2 new columns in the dataframe.

```{r createcol}

movies_new$profit <- movies_new$gross - movies_new$budget # create profit column

movies_new$roi <- (movies_new$profit)*100/(movies_new$budget) # create ROI column


```

* Show our new dataframe movies_new.

```{r datastructure, include = T}
# show dataframe structure
str(movies_new)


```

#### 2.3 Data Visualization

```{r datahist, include = T}

ggplot(data = movies_new, aes(x = year)) +
  geom_histogram(alpha = 0.5, fill = "blue", col = "red", binwidth = 1) +
  ggtitle("Histogram of published movies from 1986-2016") +
  xlab("Year") +
  ylab("Number of Movies") +
  theme(plot.title = element_text(hjust=0.5))
  
```

* Our dataset has over 200 movies per year and it is pretty good for our analysis. We do not have to treat any years with few pulished movies.


#### 2.4 Movie industry 

* In this part, we will have an overall visualization about global movie industry. 

```{r country, include = T}

# Name the country with max counts
name_max <- names(which.max(table(movies_new$country)))

# percentage that country accounts for
pp_max <- nrow(subset(movies_new, movies_new$country == name_max))*100 / nrow(movies_new)

country_table <- table(movies_new$country) # create a table with country and count no. of movies
country_table <- data.frame(country_table) # save table into a dataframe
country_table <- subset(country_table, Freq > 20) # select countries with more than 20 movies in total

# bar plot for no. of movies by country
ggplot(country_table, aes(x = reorder(Var1, Freq), y = Freq)) + 
  geom_bar(stat = 'identity', fill ='orange') + coord_flip() +
  ylab("Number of movies") +
  xlab("Country") +
  ggtitle(("Number of movies by country")) +
  theme(plot.title = element_text(hjust = 0.5)) 

```


```{r countrymap, include = T}

loadPkg("ggplot2")
loadPkg("dplyr")
loadPkg("maps")
loadPkg("viridis")

colnames(country_table)[1] <- c("region") # name column as region

# prepare label coordinate for USA
USA_map <- map_data("world", region = c("USA"))
USA_name <- USA_map %>% group_by(region) %>% summarise(long = mean(long), lat = mean(lat))

world_map <- map_data("world")
movie_map <- left_join(world_map, country_table, by = "region" ) # join movie dataset to map dataset by country/region

ggplot(data = movie_map, aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill = Freq), col = "grey") +
  geom_text(aes(label = region), data = USA_name,  size = 3, hjust = -0.7, vjust = 2.5) +
  scale_fill_viridis_c(option = "plasma") +
  ggtitle("Global Movie Industry") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Longitude") + ylab("Latitude") 
  
```



* The country with the most number of published movies over 30 years is `r name_max`.
* `r name_max` accounts for approximately `r round(pp_max)` percentage of total number of movies.
* USA is the most growing country in movie industry, as expected from their developed economy and advanced technology.
* It is interesting to investigate if USA can represent the global movie industry. To do this, we will conduct a Chi-squared test Goodness of Fit:


```{r GoodnessOfFit, include = T}

# save all genres into a vector
fullgenrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Family","Fantasy","Horror","Musical","Mystery","Romance", "Sci-Fi","Thriller", "War","Western")

USA_movies <- subset(movies_new, movies_new$country == "USA")

exp_freq <- c("")
USA_freq <- c("")

# calculate expected frequencies
j = 1
for(i in fullgenrelist) {exp_freq[j] <- nrow(subset(movies_new, movies_new$genre == i))/ nrow(movies_new); j = j + 1}
exp_freq <- as.numeric(as.character(exp_freq))

# calculate observed frequencies
k = 1
for(i in fullgenrelist) {USA_freq[k] <- nrow(subset(USA_movies, USA_movies$genre == i)); k = k + 1}
USA_freq <- as.numeric(as.character(USA_freq))

# Chi-test for Goodness of Fit
chiGoF <- chisq.test(USA_freq, p = exp_freq)


# results
chiGoF



```

* Null Hypothesis: The USA data distribution matches the global dataset.
* The p-value of the test is `r format(chiGoF$p.value, digits = 3)` which is much smaller than significance level 0.05.
* We reject the null and conclude that the USA data distribution does not match the whole dataset at 0.05 level.
* Unforetunately, we do not have enough evidence to use USA as a sample to study the global movie industry.


### Chapter 3: Movie categories
#### 3.1 SMART Question
##### Does movie genre has any effects on the movie ratings and which genre achieve highest voting averages?

#### 3.2 Number of published movies by genres:

* We will take a look at the number of published movies in each genre from 1986-2016. 

```{r count, include = T}

# show the number of published movies by genre
table(movies_new$genre)

# save new dataset including 8 popular genres
movies_fam <- subset(movies_new, movies_new$genre%in%c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror"))
movies_fam$genre <- factor(movies_fam$genre)

```


```{r pltcount, include =T}

ggplot(movies_new, aes(x=genre, fill = genre)) +
  geom_bar(stat="count", ) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle("The number of movies published by genre from 1986 to 2016") +
  guides(fill = guide_legend(title="Genre"))


```

* As we see from the table and the bar charts, there are 8 popular genres: Action, Adventure, Animation, Biography, Comedy, Crime, Drama, and Horror, in which Action, Comedy and Drama have most products.
* In contrast, Family, Fantasy, Musical, Mystery, Romance, Sci-Fi, Thriller, War and Western movies seem not to be preferred by film companies and directors. Indeed, the 8 popular genres also include the elements of Family, Fantasy, Musical, Mystery, Romance, Sci-Fi, Thriller. And War and Western movies seem not to interest viewers as they focus a lot on historical events and stories which appear frequently in papers, books and documentaries.
* In our project, we will focus analysis on most popular genres: Action, Adventure, Animation, Biography, Comedy, Crime, Drama, and Horror.

```{r save_a_genrelist}

# save 8 most popular genres into a vector
genrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror")


```


#### 3.3 Test the dependence of genre and rating:


``` {r contable}

# create contigency table with all genres

# contable1 = table(movies_new$rating, movies_new$genre)
# contable1

# create contigency table with popular genres
contable2 <- table(movies_fam$rating, movies_fam$genre)
contable2

````

* To test the dependence of genre and rating, we will conduct a Chi-squared Test Independence:

```{r chitest, include = T}

# chi-square test with all genres
#chitest1 <- chisq.test(contable1)

# results
#chitest1
#chitest1$statistic
#chitest1$parameter
#chitest1$expected
#chitest1$p.value


# chi-square test with popular genres
chitest2 <- chisq.test(contable2)

# results
chitest2
#chitest2$statistic
#chitest2$parameter
#chitest2$expected
#chitest2$p.value



```

* Null Hypothesis: The movie genre and its rating are independent.
* The p-value in the chi-squared test is `r format(chitest2$p.value, digits = 3)` much smaller than the significance level 0.05. We reject the null.
* Conclusion: The movie genre and rating are NOT independent.
* Therefore, there is an evidence at 0.05 level that movie genre and rating are related to each other.


#### 3.4 Vote and Genre relationship


```{r Vote&Genre}
anova_vg <- aov(votes ~ genre, movies_fam )
#summary(anova_vg)
tukey_vg <- TukeyHSD(anova_vg)
tukey_vg

```

* From our anova test, the p-value is `r format(summary(anova_vg)[[1]][["Pr(>F)"]][1], digit = 3)` which is much smaller than significance level (0.05). We reject the null hypothesis that the voting averages of different genres are the same.
* However, the Tukey test shows that there are some pairs with similar means. Therefore, movie genre seems not to have any influence on viewer's votes.


#### 3.4 Genres with most votes

* To have a better observation, we will divide our reseacrh period into three time intervals: 1986-1999, 2000-2009, 2010-2016
* Then, we save our movies data into three datasets.

``` {r databyperoid, echo= F}
movies1 <- subset(movies_fam, movies_fam$year%in%c(1986:1999)) # dataset 1 from 1986-1999
movies2 <- subset(movies_fam, movies_fam$year%in%c(2000:2009)) # dataset 2 from 2000-2009
movies3 <- subset(movies_fam, movies_fam$year%in%c(2010:2016)) # dataset 3 from 2010-2016
#str(movies1)
#str(movies2)
#str(movies3)
```


* We determine the genre with most votes based on number of votes per movie.

```{r def, echo = F}

# define a function to plot
pltm = function(x) {
  genrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror")
  vote_avg <- c("")
  j = 1
  
  for(i in genrelist) {vote_avg[j] <- mean((subset(x, x$genre == i))$votes, na.rm = T)*(1e-3); j = j + 1}
  
  df = data.frame(meanvote = vote_avg, genrevote = genrelist)
  df$meanvote <- as.numeric(as.character(df$meanvote))
  
  p <- ggplot(df, aes(x="", y=meanvote, fill = genrevote)) +
    geom_bar(width=1, stat = "identity", color = "white") +
    coord_polar("y", start=0) +
    guides(fill=guide_legend(title="Genre")) +
    theme(axis.text  = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()) +
    geom_text(aes(label = paste0( scales::percent(meanvote / sum(meanvote)))), position = position_stack(vjust = 0.5))
  

  return(p)


}
```




```{r genrevotes, echo = F}

# No. of votes per movie in the whole period
pltm(movies_fam) +
  ggtitle("Ratio of votes per movie") +
  theme(plot.title = element_text(hjust = 0.5))

# No. of votes per movie in 1986-1999
pltm(movies1) +
  ggtitle("Ratio of votes per movie in 1986-1999") +
  theme(plot.title = element_text(hjust = 0.5)) 
 

# No. of votes per movie in 2000-2009
pltm(movies2) +
  ggtitle("Ratio of votes per movie in 2000-2009") +
  theme(plot.title = element_text(hjust = 0.5))

# No. of votes per movie in 2010-2016
pltm(movies3) +
  ggtitle("Ratio of votes per movie in 2010-2016") +
  theme(plot.title = element_text(hjust = 0.5))


```

* As we see from the plots: Action, Animation, Adventure and Crime are always the most-voted genres.
* During the first period, Animation and Crime were the most favorite genres. In the second period, Action and Adventure grew as the most favorite genres and in recent years, these two genres have still maintained their posistions. 
* In contrast, Animation and Crime had a significance backward after three periods. Although they still are in top 4 genres with most votes, their first and second places were taken by Action and Adventure.
* Comedy and Horror seems to be the least interested genres as they always receive least votes.
* Overall, Action is the genre that receives most votes from customers.


### Chapter 4: Movie Scores
#### 4.1 SMART Question
##### Is there any relationships between the votes and the scores, and are the score means the same across all genres and all ratings?

#### 4.2 Scores and Votes Relationship

* We divide votes and scores into different categories:

Votes:

- High votes: from 1,000,000  
- Medium votes: from 500,000 to below 1,000,000
- Low votes: below 500,000

Scores:

- Good score: from 7.5
- Medium score: from 5.0 to below 7.5
- Bad score: below 5.0

Now, we plot the distribution of votings across the scores using boxplots and mapping plots"

```{r pltVotesVsScore, include = T}

high_votes <- subset(movies_new, votes > 1e+6 | votes == 1e+6)
medium_votes <- subset(movies_new, votes < 1e+6 & votes > 500000 | votes == 500000)
low_votes <- subset(movies_new, votes < 500000)


# boxplot for score distribution by different ranges of votes
ggplot() +
  ggtitle("Score distribution with different groups of votes") +
  geom_boxplot(data=high_votes, aes(x=1,y=score,fill="1")) +
  geom_boxplot(data=medium_votes, aes(x=2,y=score,fill="2")) +
  geom_boxplot(data=low_votes, aes(x=3,y=score,fill="3")) +
  theme(plot.title = element_text(hjust=0.5),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(title = "Vote categories")) +
  scale_fill_manual(labels=c("High","Medium","Low"),values = c("blue","red","yellow"))
  
# geomplot for score and vote
ggplot() +
  ggtitle("Votes distribution over score") +
  geom_point(data=movies_new,mapping=aes(x=score,y=votes,col=genre)) +
  theme(plot.title = element_text(hjust=0.5)) +
  geom_hline(linetype="dashed", aes(yintercept = 1e+6)) + 
  geom_vline(linetype="dashed", aes(xintercept = 7.5)) +
  geom_hline(linetype="dashed", aes(yintercept = 500000)) + 
  geom_vline(linetype="dashed", aes(xintercept = 5.0)) +
  annotate("text", x = 8.6, y = 15*(1e+5), label = "High Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 15*(1e+5), label = "High Votes\nMedium Score") +
  annotate("text", x = 2.5, y = 15*(1e+5), label = "High Votes\nLow Score") +
  #annotate("text", x = 8.6, y = 750000, label = "Medium Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 750000, label = "Medium Votes\nMedium Score") +
  #annotate("text", x = 2.5, y = 750000, label = "Medium Votes\nLow Score") +
  annotate("text", x = 8.6, y = 250000, label = "Low Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 250000, label = "Low Votes\nMedium Score") +
  annotate("text", x = 2.5, y = 250000, label = "Low Votes\nLow Score")

#qqnorm(movies_new$votes)
#qqnorm(movies_new$score)

```

* As shown in boxplots, the movies with highest votes (above 1 million votes) tend to have high scores and the movies with low scores (below 5) tend to get bad votes. However, high score movies do not certainly have high votes and low votes movies do not mean that they have low score. 
* The mapping plot also gives us the same observation, every movies with votes over 1 million always possesses a high score. And at around 500000 votes and below, the score varies extensively. Movies with scores below 5.0 have low votes.
* This illustrates that people often highly grade their favorite movies (with high votes). Meanwhile, they do not recommend bad movies (low score). The reason for the large variety of scores at medium votes (below 500000) may be due to the genre of the movies that affect the number of audiences. Many genres have good quality of movies but they are not of interest to audiences such as Biography, War, Scifi, Drama, which makes them get low votes even they are highly graded.


#### 4.3 Score by genres and ratings

##### By genres:

* Anova test score means by famous genres: 

```{r AOV_score&genre, include =T}

anova_sg <- aov(score ~ genre, movies_fam)
summary(anova_sg)

```

* Null Hypothesis: The score means of all genres are the same.
* The p-value of the test is `r format(summary(anova_sg)[[1]][["Pr(>F)"]][1], digits = 3)`, which is very close to 0 and much smaller than significance level (0.05).
* We reject the null: the scores average of different genres are not all the same.


```{r pltScore&Genre, echo = F, include = T}
ggplot() +
  geom_boxplot(data=movies_fam, aes(x=genre, y=score, fill=genre)) +
  ggtitle("Score distribution by genres") +
  theme(plot.title=element_text(hjust=0.5))
  
```

* As shown in the boxplots, the following pairs have pretty the same tall boxplots and overlapped interquartile ranges: Action-Comedy, Animation-Crime, Animation-Drama and Crime-Drama.
* This illustrates that these pairs seem to be NOT significant in their mean values. 
* We will conduct an ad hoc procedure using Tukey test to see which pairs are significant and check whether our visualization is correct. 

```{r TukeyTest1, echo = F, include = T}

tukey1 <- TukeyHSD(anova_sg)
tukey1
```


* As we see from our Tukey test, there are no significant differences in means of the following pairs: Action-Comedy, Animation-Crime, Animation-Drama, Crime-Drama, while the other pairs are significant.
* The results match our observation from the boxplots.
* Since there are some pairs with the same mean, it seems that the score is not dependent on movie genre.

##### By ratings:

```{r AOV_score&rating}

anova_sr <- aov(score ~ rating, movies_fam )
summary(anova_sr)

```

* Null Hypothesis: The score means of all ratings are the same.
* The p-value of the test is `r format(summary(anova_sr)[[1]][["Pr(>F)"]][1], digits = 3)`, which is very close to 0 and much smaller than significance level (0.05).
* Therefore, we reject the null and conclude that the scores means of different ratings are not all the same.

```{r pltScore&Rating, echo = F, include = T}
ggplot() +
  geom_boxplot(data=movies_fam, aes(x=rating, y=score, fill=rating)) +
  ggtitle("Score distribution by ratings") +
  theme(plot.title=element_text(hjust=0.5))
  
```


```{r TukeyTest2, echo = F, include = T}

tukey2 <- TukeyHSD(anova_sr)
tukey2
```

* As we see from our Tukey test, there are significant differences in score means of the following pairs: PG-13 & R, PG & R, PG & PG-13, G & PG.
* The other pairs are not significnace at 0.05 level.



### Chapter 5: Movie Commerce

#### 5.1 SMART Question

##### Which genres are good selections for commercial success? By analyzing the profit and the return on investment (ROI) of different genres from 1986 - 2016 which suggestions we should give to the movie companies?

#### 5.2 Profit distribution:


```{r prfnormality, include = T}

# Q-Q plot with outliers
qqnorm(movies_fam$profit, main = "Normal Q-Q plot with outliers")
qqline(movies_fam$profit, col = "red", lw = 2)

# remove outliers to have a better assumption of profit distribution
outliers <- boxplot(data=movies_fam, profit ~ genre, plot = F)$out # remove outliers
movies_fam_noOut <- subset(movies_fam, ! movies_fam$profit%in%outliers) # a subset without outliers


# Q-Q plot without outliers
qqnorm(movies_fam_noOut$profit, main = "Normal Q-Q plot without outliers")
qqline(movies_fam_noOut$profit, col = "red", lw = 2)



```
* The Q-Q plot with outliers shows a distribution with over-dispersed data due to outliers. To have a better visualization, we will remove outliers and plot the Q-Q plot again.
* The profit distribution looks different from a normal distribution. The profit looks to have an extreme right skew and fatter tails than a normal distribution.
* Since profit shows an extreme right skew, the frequency is higher to the left. If we select the mean as threshold and randomly choose a movie, this movie will likely have lower profit than the threshold. In other words, the majority of movies tend to have a lower profit than the average.
* This pattern will not statisfy movie organizations. They expect a profit distribution with more concentration on the right (left skew). 


The 5-number summary of profit (including the mean) in table format:

```{r prfsummary, include = T}
summary(movies_fam$profit)

```

* The median is small than zero, which means that more than 50% of published movies have no profit. This shows that there is a high chance for a movie company to have a net-less with their product.
* To help movie companies to address the issue of profit, we will conduct a deeper analysis on movie profit.

#### 5.3 Profit by genres


```{r profitboxplots}

# plot with outliers
ggplot() +
  geom_boxplot(data = movies_fam, aes(x=genre, y=(profit*(1e-6)), fill=genre)) +
  ggtitle("Profit distribution by genres") +
  xlab("Genre") +
  ylab("Profit (millions USD)") +
  theme(plot.title = element_text(hjust = 0.5))
  
# plot without outliers
ggplot() +
  geom_boxplot(data = movies_fam_noOut, aes(x=genre, y=(profit*(1e-6)), fill=genre)) +
  ggtitle("Profit distribution by genres without outliers") +
  xlab("Genre") +
  ylab("Profit (millions USD)") +
  theme(plot.title = element_text(hjust = 0.5))
  

```

* From the first figure (with outliers), both the most net-income movie and the most net-loss movie belong to Action genre. 
* The Animation and Horror have their median lines at the highest positions and lie over zero, showing that these two genres provide good ratios of profitable movies (more than 50% of movies have profit). It seems to be a safer choice to invest on Animation and Horror rather than other genres.

* Observe Animation and Horror distribution:

```{r Ani&Hor, include = T}

# Animation normality
Ani <- subset(movies_fam_noOut, genre == "Animation") # a subset including Animation movies only
qqnorm(Ani$profit, main = "Normal Q-Q plot of Animation")
qqline(Ani$profit, col ="blue", lw = 2)
hist(Ani$profit, main ="Histogram of Animation", col = "yellow1", xlab = "Profit")

# Horror normality
Hor <- subset(movies_fam_noOut, genre == "Horror") # a subset including Horror movies only
qqnorm(Hor$profit, main = "Normal Q-Q plot of Horror")
qqline(Hor$profit, col = "blue", lw = 2)
hist(Hor$profit, main ="Historgram of Horror", col = "chocolate1", xlab = "Profit")

```

* As we see from the Q-Q plots, profit distributions of Animation and Horror look roughly normally distributed. Both distributions have a slight right skew. Although movie companies expect a left skew distribution but a slight right skew distribution is still acceptable.

* We observe the ratio of profitable movies in each genre: 

```{r ratioProfit, include = T}

gain_mv <- subset(movies_fam, movies_fam$profit > 0)
#loss_mv <- subset(movies_fam, movies_fam$profit < 0 | movies_fam$profit == 0)

genrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror")

ratio <- c("")
j = 1

# ratio (numbers of movie with positive income)/(numbers of movie) by each genre

for(i in genrelist) {ratio[j] <- nrow(subset(gain_mv, gain_mv$genre == i))*100/nrow(subset(movies_fam,(! (is.na(movies_fam$profit)) & (movies_fam$genre == i)))); j = j+1} # calculate ratio and save to a vector

ratio_df <- data.frame(Ratio = ratio, Genre = genrelist) # save ratio and related genre to a new dataframe
ratio_df$Ratio <- as.numeric(as.character(ratio_df$Ratio)) # change factor to numeric 
ratio_df <- ratio_df[order(ratio_df$Ratio, decreasing = T),] # ordering
ratio_df


```

* As shown in the table, Horor and Animation have highest ratio of profitable movies, matching our observation from the boxplots.
* Movie companies and directors are recommended to invest in these two categories: Animation and Horror.
* Now, we will take a look at the distribution of profit average (profit per movie) by genres.

```{r avgprofitdef}

pf = function(x) {
  genrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror")
  profit_avg <- c("")
  j = 1
  
  for(i in genrelist) {profit_avg[j] <- mean((subset(x, x$genre == i))$profit, na.rm = T)*(1e-3); j = j + 1}
  
  df = data.frame(meanprofit = profit_avg, genreprofit = genrelist)
  df$meanprofit <- as.numeric(as.character(df$meanprofit))

  
  p <- ggplot(df, aes(x="", y=meanprofit, fill = genreprofit)) +
    geom_bar(width=1, stat = "identity", color = "white") +
    coord_polar("y", start=0) +
    guides(fill=guide_legend(title="Genre")) +
    theme(axis.text  = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()) +
    geom_text(aes(label = paste0( scales::percent(meanprofit / sum(meanprofit)))), position = position_stack(vjust = 0.5))
  

   return(p)
  
}
```


```{r pltProfit, echo=F}

# comparision of  profit per movie of each genre across different periods of time

pf(movies_new) +
  ggtitle("Profit Average distribution by Genres") +
  theme(plot.title = element_text(hjust = 0.5)) 
 
pf(movies1) +
  ggtitle("Profit Average distribution by Genres in 1986-1999") +
  theme(plot.title = element_text(hjust = 0.5)) 
 
pf(movies2) +
  ggtitle("Profit Average distribution by Genres in 2000-2009") +
  theme(plot.title = element_text(hjust = 0.5)) 
 
pf(movies3) +
  ggtitle("Profit Average distribution by Genres in 2010-2016") +
  theme(plot.title = element_text(hjust = 0.5)) 
  
  


```

* As we see from our pie charts, Animation, Adventure and Horor are always the most profitable genres. 
* Animation is the genre giving most profit per movie. It is understandable since Animation does not require budget to hire actors and investment on visual effects and movie set.
* Adventure and Horror places next since those genres also do not require a lot of investment but achieve good income.
* Although Action is the one of the genres with most votes, its movies do not earn good profit. The reason is that Action movies require a considerable investment on actors, visual effects and movie set which cost a lot of expenditure.


Calculate profit and mapping plot (x=budget, y=profit, color by genre/rating)

```{r mappingProfit, echo=F, include = T, warning = F}
ggplot() +
  geom_point(data=movies_fam, mapping=aes(x=(budget*(1e-6)), y=(profit*(1e-6)), col = genre)) +
  xlab("Budget (millions USD)") +
  ylab("Profit (millions USD)") +
  ggtitle("Profit vs Budget map") +
  theme(plot.title = element_text(hjust = 0.5)) 

```

* As we see that, low budget movies tend to make profit, while higher budget movies are at risk of having losses: As budget value increases, the range of gross-loss value also increases.
* High-profit movies (mostly action genre) require pretty high budgets (more than `r quantile(movies_fam$budget, 0.95, na.rm=T)*(1e-6)` m$, i.e 95 percentile value).
* Horror seems to have a low budget but their income is impressive. Horror seems to be the most successful movie genre. We will confirm this with analysis on Return on Investment (ROI).


#### 5.4 Return on Investment

* Return on Investment is calculated as the ratio of Profit over Budget: Return on Investment (ROI) = (Profit) / (Budget)
* Return on Investment determines whether a movie is successful.


```{r mappingROI, echo=F, include = T, warning = F}

# plot return on investment ~ budget
ggplot() +
  geom_point(data=movies_fam, mapping=aes(x=(budget*(1e-6)), y=roi, col = genre)) +
  xlab("Budget (millions USD)") +
  ylab("Return on Investment (%)") +
  ggtitle("Return on Investment vs Budget map") +
  theme(plot.title = element_text(hjust = 0.5)) 



```

* As we claimed, Horror movies have low budget and high profit, resulting in a very high return on investment (ROI=Profit/Budget). 
* We can conclude that Horror is the most successful genre in movie business.
* However, it is hard for us to visualize other genre. We need to remove outliers for a better observation.
* We remove outliers and create new plots:


```{r remappingROI, echo=F, include = T, warning = F}

# plot return on investment ~ budget wihout outliers
ggplot() +
  geom_point(data=subset(movies_fam,! movies_fam$roi%in%boxplot(roi ~ genre, data=movies_fam, plot = F)$out), mapping=aes(x=(budget*(1e-6)), y=roi, col = genre)) +
  xlab("Budget (millions USD)") +
  ylab("Return on Investment (%)") +
  ggtitle(("Return on Investment vs Budget map without outliers")) +
  theme(plot.title = element_text(hjust = 0.5)) 


# boxplot ROI by genres without outliers
ggplot(data=subset(movies_fam,! movies_fam$roi%in%boxplot(roi ~ genre, data=movies_fam, plot = F)$out), aes(x=genre, y=roi, fill=genre)) +
  geom_boxplot() +
  xlab("Genre") +
  ylab("Return on Investment (%)") +
  ggtitle(("Return on Investment distribution by genres without outliers")) +
  theme(plot.title = element_text(hjust = 0.5)) 

  

```

* As expected, Horror movies still possess high return on investment. 
* Action movies seem not to do well in Return on Investment. Due to its characteristics, Action requires high expenditures which lead to its low return on investment.
* The Return on Investment tends to reduce as the budget increases. Therefore, low budget movie tend to be more successful than high budget movie in movie commerce.

#### 5.5 Profit and Votes Relationship

```{r ProfitvsVotes, echo=F, include = T, warning = F}
ggplot() +
  geom_point(data=movies_fam, mapping=aes(x=votes, y=(profit*(1e-6)), col = genre)) +
  xlab("Votes") +
  ylab("Profit (millions USD)") +
  ggtitle("Profit vs Votes map") +
  theme(plot.title = element_text(hjust = 0.5)) 

```

* There is no clear relationship between profit and votes. Votes seem not to be a factor to profit.

* The only thing we see is that movies with more than 500,000 votes seem to have a safe income, most of these movies have positive profits. The major of movies with net-losses belong to the group of below-500,000 votes movies.

#### 5.6 Profit and Scores Relationship

```{r ProfitvsScore, echo=F, include = T, warning = F}
ggplot() +
  geom_point(data=movies_fam, mapping=aes(x=score, y=(profit*(1e-6)), col = genre)) +
  xlab("Score") +
  ylab("Profit (millions USD)") +
  ggtitle("Profit vs Score map") +
  geom_vline(linetype="dashed", aes(xintercept = 3.5)) +
  geom_hline(linetype="dashed", aes(yintercept = 350)) +
  theme(plot.title = element_text(hjust = 0.5)) 

```


* Score seems not to contribute a lot to profit. There are only two remarkle features: Movies that earn very high profits (more than 350 m$) often achieve good scores (around 7.0), whereas very low score movies (less than 3.5) earn small profits and can also have net-losses.

* Except movies with significantly high profits or significantly low scores, the others have their profits vary widely and unpredictably in every score grade.


### Chapter 6: Conclusion

* In summary, there are many insights from our analysis on movie industry:
1. USA is the biggest movie industry since around 74% of published movies worldwide come from this country. However, USA is not an appropriate sample to study the global movie industry because there is no evidence that USA data match the wolrd data.
2. From our testing, we observe a relationship between movie genre and ratings. In other words, genre is a factor to decide a movie rating. It is understandable since different categories are determined by their target audiences, contents and level of violence which are also the basis to restrict the range of viewers.
3. Although there is no clear relationship between movie scores and its votes, we can conclude that a movie with low score will always receive few votes and a movie with lots of votes will score well.
4. We do not have enough evidence to determine if movie genre has any effect on customers' score and votes.
5. The most profitable movie belongs to Action but the most successful genre is Horror. Animation has highest profit per movie and maintain a stability in making income over the three decades. 

* Finally, we have a suggestions for movie companies and directors:
1. If companies have little budget or want to navigate to the success of their products, they should invest on Horror movies. Horror also possess a decent profit per movie. 
2. If a company prioritizes the profit, Animation is a safe and stable choice.
3. If a company has strong economic potential and possesses expert directors and actors, they can invest on Action genre. Although this selection is risky but it can reward a considerable amount of income if the movie is successful.
