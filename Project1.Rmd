---
title: "Project 1 - DATS 6101"
author: "GROUP NAME"
date: "9/29/2019"
output:
   html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r define_loadPkg, echo=F}
loadPkg = function(x) { if (!require(x,character.only=T, quietly =F)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T, quietly=T)) stop("Package not found") } }
```

### Chapter 1: Introduction


### Chapter 2: Description of Data
#### 2.1 Source Data
#### 2.2 Clean Data

* For our project, we will remove all movies that are television or DvDs versions and focus on movies published at theatre/ cinema.
* Change all movies with budget = 0 to NA.

```{r dataclean, echo = F, message = F}

loadPkg("ggplot2")
# read dataset
movies <- read.csv("movies.csv")

# assign NA to movies with budget = 0 
movies$budget <- replace(movies$budget,movies$budget==0, NA)

#unique(movies$rating) # check rating types
#unique(movies$genre) # check genre types

# filter for movies with MPAA film rating system 
movies_new <- subset(movies, movies$rating%in%c("G","NC-17","PG-13","R","PG"))
# movies$genre%in%c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror"))

# apply factor again to new dataset
movies_new$rating <- factor(movies_new$rating) 
movies_new$genre <- factor(movies_new$genre)
str(movies_new)


```


### Chapter 3: Movie categories
#### 3.1 SMART Question
##### Does the genre has any effects on the classification of audiences and which genre achieve highest voting averages in three time intervals: 1986-1999, 2000-2010, and 2010-2016?

#### 3.2 Test the dependence of genres and ratings

Movie ratings explanation:

* G – General Audiences: All ages admitted. Nothing that would offend parents for viewing by children.
* PG – Parental Guidance Suggested: Some material may not be suitable for children. Parents urged to give "parental guidance". May contain some material parents might not like for their young children.
* PG-13 – Parents Strongly Cautioned: Some material may be inappropriate for children under 13. Parents are urged to be cautious. Some material may be inappropriate for pre-teenagers.
* R – Restricted: Under 17 requires accompanying parent or adult guardian. Contains some adult material. Parents are urged to learn more about the film before taking their young children with them.
* NC-17 – Adults Only: No One 17 and Under Admitted. Clearly adult. Children are not admitted.



* We will take a look at the number of movies published in each genre from 1986-2016. Any small size samples (the number of movies published is smaller than 50) will not be inlcuded in analysis to ensure reasonable results.

```{r count, echo = F, include = T}

# show the number of published movies by genre
table(movies_new$genre)

# save new dataset with famous genres
movies_fam <- subset(movies_new, movies_new$genre%in%c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror"))
movies_fam$genre <- factor(movies_fam$genre)

```


```{r pltcount, echo = F, include =T}

ggplot(movies_new, aes(x=genre, fill = genre)) +
  geom_bar(stat="count", ) +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle("The number of movies published by genre from 1986 to 2016") +
  guides(fill = guide_legend(title="Genre"))


```


* Create Contigency Table:

``` {r contable, echo = F, include = T}

#contable1 = table(movies_new$rating, movies_new$genre)
#contable1

# create contigency table
contable2 = table(movies_fam$rating, movies_fam$genre)
contable2

````

* Chi-squared Test:

```{r chitest, echo = F, include = T}

# chi-square test
#chitest1 <- chisq.test(contable1)

# results
#chitest1
#chitest1$statistic
#chitest1$parameter
#chitest1$expected
#chitest1$p.value


# chi-square test with famous genres (large-size samples)


# chi-square test
chitest2 <- chisq.test(contable2)

# results
chitest2
chitest2$statistic
chitest2$parameter
chitest2$expected
chitest2$p.value

```

* Null Hypothesis: The movie genre and its rating are independent.
* The p-value in the chi-squared test is `r chitest2$p.value` is close to 0, much smaller than significance level (0.05). Therefore, we reject the null.
* Conclusion: The movie genre and rating are NOT independent.

#### 3.3 Genres with most votes
* To have a better observation, we will divide our reseacrh period into three time intervals: 1986-1999, 2000-2009, 2010-2016
* Then, we save our movies data into three datasets.

``` {r databyperoid, echo= F}
movies1 <- subset(movies_fam, movies_fam$year%in%c(1986:1999)) # dataset 1 from 1986-1999
movies2 <- subset(movies_fam, movies_fam$year%in%c(2000:2009)) # dataset 2 from 2000-2009
movies3 <- subset(movies_fam, movies_fam$year%in%c(2010:2016)) # dataset 3 from 2010-2016
#str(movies1)
#str(movies2)
#str(movies3)
```

```{r def, echo = F}
pltm = function(x) {
  genrelist = c("Action","Adventure","Animation","Biography","Comedy","Crime","Drama","Horror")
  vote_avg <- c("")
  j = 1
  
  for(i in genrelist) {vote_avg[j] <- mean((subset(x, x$genre == i))$votes, na.rm = T); j = j + 1}
  
  df = data.frame(meanvote = vote_avg, genrevote = genrelist)
  df$meanvote <- as.numeric(as.character(df$meanvote))
  p <- ggplot(df, aes(x=genrevote, y=meanvote, fill = genrevote)) +
    geom_bar(stat = "identity") +
    xlab("Genre") +
    ylab("Votes Mean (thousands)") +
    guides(fill=guide_legend(title="Genre"))

  
  
  return(p)


}
```




```{r genrevotes, echo = F}

# Mean votes distribution 1986-1999
pltm(movies1) +
  ggtitle("Vote Averages distribution by Genres in 1986-1999") +
  theme(plot.title = element_text(hjust = 0.5)) 
 

# Mean votes distribution 2000-2009
pltm(movies2) +
  ggtitle("Vote Averages distribution by Genres in 2000-2009") +
  theme(plot.title = element_text(hjust = 0.5))

# Mean votes distribution 2010-2016
pltm(movies3) +
  ggtitle("Vote Averages distribution by Genres in 2010-2016") +
  theme(plot.title = element_text(hjust = 0.5))


```

* As we see from the plots: During the first period, Animation and Crime were the most favorite genres. In the second period, Action and Adventure grew as the most favorite genres and in recent years, these two genres still have maintained their posistions.
* Comedy seems to be the least interested genre as over the period it always receive least votes.
* Animation seems to be the most consistent movie genre since it is always placed in top 3 of votes. 

### Chapter 4: Movie Scores
#### 4.1 SMART Question
##### Is there any relationships between the votes and the scores and are the score means the same across all genres and all ratings?

#### 4.2 Scores and Votings Relationship

* We divide votes and scores into different categories:

Votes:

- High votes: from 10^6, describes the movies with most audiences' favorite
- Medium votes: from 50000 to below 10^6
- Low votes: below 500000, describes the movies with least interest

Scores:

- Good score: from 7.5
- Medium score: from 5.0 to below 7.5
- Bad score: below 5.0

Now, we plot the distribution of votings across the scores using boxplots and mapping plots"

```{r pltVotesVsScore, echo = F, include = T, message=F}

high_votes <- subset(movies_new, votes > 1e+6 | votes == 1e+6)
medium_votes <- subset(movies_new, votes < 1e+6 & votes > 500000 | votes == 500000)
low_votes <- subset(movies_new, votes < 500000)



ggplot() +
  ggtitle("Score distribution with different groups of votes") +
  geom_boxplot(data=high_votes, aes(x=1,y=score,fill="1")) +
  geom_boxplot(data=medium_votes, aes(x=2,y=score,fill="2")) +
  geom_boxplot(data=low_votes, aes(x=3,y=score,fill="3")) +
  theme(plot.title = element_text(hjust=0.5),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(title = "Vote categories")) +
  scale_fill_manual(labels=c("High","Medium","Low"),values = c("blue","red","yellow"))
  
ggplot() +
  ggtitle("Votes distribution over score") +
  geom_point(data=movies_new,mapping=aes(x=score,y=votes,col=rating)) +
  theme(plot.title = element_text(hjust=0.5)) +
  geom_hline(linetype="dashed", aes(yintercept = 1e+6)) + 
  geom_vline(linetype="dashed", aes(xintercept = 7.5)) +
  geom_hline(linetype="dashed", aes(yintercept = 500000)) + 
  geom_vline(linetype="dashed", aes(xintercept = 5.0)) +
  annotate("text", x = 8.6, y = 15*(1e+5), label = "High Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 15*(1e+5), label = "High Votes\nMedium Score") +
  annotate("text", x = 2.5, y = 15*(1e+5), label = "High Votes\nLow Score") +
  #annotate("text", x = 8.6, y = 750000, label = "Medium Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 750000, label = "Medium Votes\nMedium Score") +
  #annotate("text", x = 2.5, y = 750000, label = "Medium Votes\nLow Score") +
  annotate("text", x = 8.6, y = 250000, label = "Low Votes\nHigh Score") +
  #annotate("text", x = 6.0, y = 250000, label = "Low Votes\nMedium Score") +
  annotate("text", x = 2.5, y = 250000, label = "Low Votes\nLow Score")

#qqnorm(movies_new$votes)
#qqnorm(movies_new$score)

```

* As shown in boxplots, the movies with highest votes (above 1 million votes) tend to have high scores and the movies with low scores (below 5) tend to get bad votes. However, high score movies do not certainly have high votes and low votes movies do not mean that they have low score. 
* The mapping plot also gives us the same observation, every movies with votes over 1 million always possesses a high score. And at around 500000 votes and below, the score varies extensively. Movies with scores below 5.0 have low votes.
* This illustrates that people often highly grade their favorite movies (with high votes). Meanwhile, they do not recommend bad movies (low score). The reason for the large variety of scores at medium votes ( below 500000) may be due to the genre of the movies that affect the number of audiences. Many genres have good quality of movies but they are not of interest to audiences such as Biography, War, Scifi, Drama, which makes them get low votes even they are highly graded.


#### 4.3 Score means of different genres and different ratings

##### By genres:

* Anova test score means by famous genres: (we will not include genres with low sample sizes < 50)

```{r AOV_score&genre, echo = F, include =T}

anova_sg <- aov(score ~ genre, movies_fam)
summary(anova_sg)

```

* Null Hypothesis: The score means of all genres are the same.
* The p-value of the test is `r summary(anova_sg)[[1]][["Pr(>F)"]][1]`, which is very close to 0 and much smaller than significance level (0.05).
* Therefore, we reject the null and conclude that the scores means of different genres are not all the same.

```{r pltScore&Genre, echo = F, include = T}
ggplot() +
  geom_boxplot(data=movies_fam, aes(x=genre, y=score, fill=genre)) +
  ggtitle("Score distribution by genres") +
  theme(plot.title=element_text(hjust=0.5))
  
```

* As shown in the boxplots, the following pairs have pretty the same tail boxplots and overlapped interquartile ranges: Action-Comedy, Animation-Crime, Animation-Drama and Crime-Drama.
* This illustrates that these pairs seem to be NOT significant in their mean values. We will confirm with a Tukey test.
* We will conduct an ad hoc procedure to see which pairs are significant.

```{r TukeyTest1, echo = F, include = T}

tukey1 <- TukeyHSD(anova_sg)
tukey1
```


* As we see from our Tukey test, there are no significant differences in score means of the following pairs: Action-Comedy, Animation-Crime, Animation-Drama, Crime-Drama.

##### By ratings:


```{r AOV_score&rating}

anova_sr <- aov(score ~ rating, movies_fam )
summary(anova_sr)

```

* Null Hypothesis: The score means of all ratings are the same.
* The p-value of the test is `r summary(anova_sr)[[1]][["Pr(>F)"]][1]`, which is very close to 0 and much smaller than significance level (0.05).
* Therefore, we reject the null and conclude that the scores means of different ratings are not all the same.

```{r pltScore&Rating, echo = F, include = T}
ggplot() +
  geom_boxplot(data=movies_fam, aes(x=rating, y=score, fill=rating)) +
  ggtitle("Score distribution by ratings") +
  theme(plot.title=element_text(hjust=0.5))
  
```



```{r TukeyTest2, echo = F, include = T}

tukey2 <- TukeyHSD(anova_sr)
tukey2
```

* As we see from our Tukey test, there are significant differences in score means of the following pairs: PG-13 & R, PG & R, PG & PG-13, G & PG.
* The other pairs are not significnace at 0.05 level.


### Chapter 5: Profit and Return on Investment
#### 5.1 Profit

Calculate profit and mapping plot (x=budget, y=profit, color by genre/rating)

#### 5.2 Return on Investment

Calulate ROI and mapping plot (x=budget, y=ROI, color by genre/rating)

#### 5.3 Profit and Votes Relationship

#### 5.4 Profit and Scores Relationship


### Chapter 6: 
For chapter 6, we can use countries to analyze but it will be very long. So we can have another option is to use ROI as our chapter 6.

### Chapter 7: Conclusion